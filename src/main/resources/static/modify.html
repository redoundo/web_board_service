<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시판 - 수정</title>
    <meta charset="UTF-8">
</head>
<body>
<h2>게시판 - 수정</h2>
<div th:object="${content}">
    <h5>기본정보</h5>
    <form id="modifyForm" enctype="multipart/form-data" th:action>
        <div>
            <span>카테고리</span>
            <span th:text="${categoryName}">null</span>
        </div>
        <div>
            <span>등록일시</span>
            <span th:text="${content.getSubmitDate()}">-</span>
        </div>
        <div>
            <span>수정 일시</span>
            <span th:text="${content.getUpdateDate()}">-</span>
        </div>
        <div>
            <span>조회수</span>
            <span th:text="${content.getViewCount()}">0</span>
        </div>
        <div>
            <span><label for="changeNickname">작성자*</label></span>
            <span>
                <input id="changeNickname" required th:value="${content.getNickname()}"
                         value="-" minlength="2" maxlength="20"/>
            </span>
        </div>
        <div>
            <span><label for="checkPasswordForModify">비밀번호*</label></span>
            <span>
                <input type="password" id="checkPasswordForModify" name="password" placeholder="비밀번호" required
                       minlength="4" maxlength="18"/>
                <input type="hidden" id="originalPassword" th:value="${content.getPassword()}"/>
                <input type="hidden" name="contentId" th:value="${content.getContentId()}"/>
            </span>
        </div>
        <div>
            <span><label for="changeTitle">제목*</label></span>
            <span>
                <input type="text" id="changeTitle" name="title" required th:value="${content.getTitle()}"
                         minlength="3" maxlength="70"/>
            </span>
        </div>
        <div>
            <span><label for="changeContent">내용*</label></span>
            <span><input type="text" id="changeContent" name="content" required th:value="${content.Content()}"
                         minlength="5" maxlength="800"/></span>
        </div>
        <div>
            <span>파일첨부</span>
            <span id="changeFiles" th:object="${files}">
                <th:block th:if="${files != null && files.size()>0}" th:each="file : ${files}">
                    <form class="changeFileForm" method="post" action="modify/download" th:id="|notFile${fileStat.count}|">
                        <span>
                            <input type="hidden" th:name="notFile${fileStat.count}" th:value="${file.getFileId()}"/>
                            <span>파일</span>
                            <span th:text="${file.getFileName()}">-</span>
                            <span><input type="submit" value="DOWNLOAD"/></span>
                            <span>
                                <button th:id="|buttonnotFile${fileStat.count}|" type="button" onclick="deleteMySelf(this.id)">
                                    지우기
                                </button>
                            </span>
                        </span>
                    </form>
                </th:block>
                <th:block th:if="${files != null && 3 - files.size() >0}"
                          th:each="num: ${#numbers.sequence(1,(3 - files.size()))}">
                    <input type="file" th:name="|file${numStat.count}|"/>
                </th:block>
            </span>
        </div>
    </form>
    <span>
        <button type="button" onclick="goBack('/view.html')">취소</button>
        <input type="submit" form="modifyForm" onsubmit="checkPassword()"
               formaction="update" formenctype="multipart/form-data" value="저장"/>
    </span>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    let error = [[${error.errorMessage}]];
    alert(error);//에러가 설정되면 alert 창 띄우기
    function goBack(where) {
        let url = window.location.href;
        if (url.includes("?") && url.includes("=")) {
            let query = url.split("?")[1];
            return location.href = where + "?" + query;
        } else {
            return location.href = where;
        }
    }

    function deleteMySelf(id) {
        let files = document.getElementsByClassName("changeFileForm");
        let name = "file" + (3 - files.length) + 1;
        const me = document.getElementById(id.replace("button" , ""));
        me.remove();
        $("#changeFiles").append(`<input type="file" name=${name}/>`)
    }
    function checkPassword(){
        let same = false;
        $.ajax({
            method : "post" , url : "checkPassword" ,
            data : {password : $("#passwordForDelete").val() , original : $("#originalPassword").val()} ,
            success : function(val){
                if(val !== null){
                    same = val
                    if(val === false){
                        alert("비밀번호가 동일하지 않습니다!!");
                    }
                }
            } ,
            error : function(err){
                console.log(err);
                alert("잠시 후 다시 시도해주세요.");
            }
        })
        return same;
    }
    /*]]>*/
</script>
</body>
</html>